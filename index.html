<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>NumerID</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiM1NUM0NUYiLz48dGV4dCB4PSIzMiIgeT0iMzIiIGZvbnQtc2l6ZT0iNDYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiBmaWxsPSIjMDAwIiBmb250LXdlaWdodD0iNzAwIiBmb250LWZhbWlseT0iUm9ib3RvLCBTYW5zLXNlcmlmIj5JRDwvdGV4dD48L3N2Zz4=">

<style>
  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: #f7f7f5;
    color: #222;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
  }

  .wrapper {
    width: 90%;
    max-width: 640px;
    margin: 30px 0;
  }

  .header {
    background: #9fdc00;
    color: #000;
    padding: 30px 0;
    font-size: 3em;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 16px;
  }

  .header sub {
    font-size: 0.25em;
    opacity: 0.3;
    margin-left: -5px;  
  }

  .section {
    margin: 30px 0;
    padding: 18px 35px 30px 35px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    position: relative;
  }

  .section h2 {
    color: #000;
    font-size: 1.3em;
    margin-top: 0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .help-btn {
    background: #9fdc00;
    border: none;
    color: #000;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }

  .help-btn:hover { background: #7cc400; }

  .tooltip {
    display: none;
    position: absolute;
    top: 0;
    left: 30px;
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 14px 18px;
    border-radius: 10px;
    font-size: 0.95em;
    line-height: 1.5em;
    text-align: left;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
  }

  .tooltip b {
    color: #9fdc00;
    font-weight: 600;
  }

  .help-btn:hover .tooltip { display: block; }

  input {
    width: 100%;
    padding: 10px;
    font-size: 1em;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 8px;
  }

  .kontrola-btn {
    background: #000;
    color: #9fdc00;
    border: none;
    border-radius: 10px;
    padding: 10px 22px;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    margin-right: 10px;
  }
  
  .ocr-btn {
    background: #000;
    color: #9fdc00;
    border: none;
    border-radius: 10px;
    padding: 10px 22px;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    margin-right: 10px;
  }

  .kontrola-btn:hover { background: #333; }
  .ocr-btn:hover { background: #333; }

  /* výstup MRZ vlevo od hlavní sekce */
  .mrz-result {
    display: none;
    position: absolute;
    top: 0;
    left: -350px;
    width: 300px;
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.95em;
    line-height: 1.4em;
    text-align: left;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    white-space: pre-wrap;
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .mrz-result.show {
    display: block;
    opacity: 1;
    transform: translateX(0);
  }

  .mrz-result b { color: #9fdc00;}
  .mrz-result .ok { color: #9fdc00; font-weight:600; }
  .mrz-result .bad { color: #ff6b6b; font-weight:600; }

.insert-btn {
  background: #888;         
  color: #fff;              
  padding: 10px;
  font-size: 1em;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 8px;
  opacity: 0.3; 
  transition: opacity 0.2s;
}

.insert-btn:hover {
  opacity: 1;              
}

/* Styly pro velký, modální OCR video/výběrovou oblast */
#ocr-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: none;
    cursor: pointer;
}

#ocr-holder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    padding: 0;
    max-width: 90vw; /* Velké zobrazení */
    max-height: 90vh;
    display: none;
}

#ocr-holder video { 
    max-width: 100%; 
    max-height: 80vh; 
    height: auto;
    border: 3px solid #9fdc00; 
    display: block; 
}

#ocr-selection { 
    position: absolute; 
    border: 2px dashed red; 
    pointer-events: none; 
}

#ocr-canvas { display: none; }

.ocr-status {
    margin-left: 10px;
    margin-top: 20px;  
    font-size: 0.8em; 
    font-weight: 600;
    line-height: 1.2;
    display: inline-block;
    color: #000;
}

.ocr-close-btn {
    position: absolute;
    top: -40px;
    right: 0;
    background: #ff6b6b;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px;
    font-size: 0.9em;
    cursor: pointer;
    z-index: 10001;
}

.ocr-close-btn:hover {
    background: #ff5252;
}

/* Responzivní styly pro mobilní zařízení */
@media (max-width: 768px) {
    .wrapper {
        width: 95%;
        margin: 15px 0;
    }
    
    .header {
        font-size: 2.2em;
        padding: 20px 0;
        border-radius: 12px;
    }
    
    .section {
        margin: 20px 0;
        padding: 15px 20px 20px 20px;
        border-radius: 12px;
    }
    
    .mrz-result {
        position: relative;
        left: 0;
        width: 100%;
        margin-top: 15px;
        transform: translateX(0);
    }
    
    .mrz-result.show {
        transform: translateX(0);
    }
    
    #ocr-holder {
        max-width: 95vw;
        max-height: 85vh;
    }
    
    .kontrola-btn, .ocr-btn {
        padding: 8px 16px;
        font-size: 1em;
        margin-right: 8px;
        margin-bottom: 8px;
    }
}

@media (max-width: 480px) {
    .header {
        font-size: 1.8em;
        padding: 15px 0;
    }
    
    .section {
        padding: 12px 15px 15px 15px;
    }
    
    .section h2 {
        font-size: 1.1em;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .help-btn {
        margin-top: 8px;
        align-self: flex-end;
    }
    
    .kontrola-btn, .ocr-btn {
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
    }
    
    input {
        font-size: 0.9em;
        padding: 8px;
    }
}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">NumerID<sub>v0.2</sub></div>

 
<div class="section" id="mrz-id-section">
  <h2>MRZ – OP/NPT/PPP
    <button class="help-btn" aria-label="Zobrazit nápovědu pro MRZ OP/NPT/PPP">?
      <div class="tooltip">1. Zadej první, druhý a třetí řádek MRZ včetně šipek.<br>
          2. Šipky můžeš vkládat pomocí kliknutí na tlačítko vedle vkládacího pole.<br>
          3. Poté klikni na <b>KONTROLA</b>.<br>
        </div>
    </button>
  </h2>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 1 (MRZ ID)" aria-label="První řádek MRZ pro OP/NPT/PPP">
    <button class="insert-btn" style="margin-left:5px;" aria-label="Vložit šipku">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 2 (MRZ ID)" aria-label="Druhý řádek MRZ pro OP/NPT/PPP">
    <button class="insert-btn" style="margin-left:5px;" aria-label="Vložit šipku">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 3 (MRZ ID)" aria-label="Třetí řádek MRZ pro OP/NPT/PPP">
    <button class="insert-btn" style="margin-left:5px;" aria-label="Vložit šipku">&lt;</button>
  </div>
  <button class="kontrola-btn" aria-label="Provést kontrolu MRZ">KONTROLA</button>
  <button class="ocr-btn" data-lines="3" aria-label="Spustit OCR pro načtení MRZ">OCR</button> 
  <span class="ocr-status"></span> <div class="mrz-result" aria-live="polite"></div>
</div>


<div class="section" id="mrz-passport-section">
  <h2>MRZ – Cestovní pas 
    <button class="help-btn" aria-label="Zobrazit nápovědu pro MRZ cestovního pasu">?
      <div class="tooltip">1. Zadej první a druhý řádek MRZ včetně šipek.<br>
          2. Šipky můžeš vkládat pomocí kliknutí na tlačítko vedle vkládacího pole.<br>
          3. Poté klikni na <b>KONTROLA</b>.<br>
        </div>
    </button>
  </h2>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 1 (MRZ pas)" aria-label="První řádek MRZ pro cestovní pas">
    <button class="insert-btn" style="margin-left:5px;" aria-label="Vložit šipku">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 2 (MRZ pas)" aria-label="Druhý řádek MRZ pro cestovní pas">
    <button class="insert-btn" style="margin-left:5px;" aria-label="Vložit šipku">&lt;</button>
  </div>
  <button class="kontrola-btn" aria-label="Provést kontrolu MRZ">KONTROLA</button>
  <button class="ocr-btn" data-lines="2" aria-label="Spustit OCR pro načtení MRZ">OCR</button> 
  <span class="ocr-status"></span> <div class="mrz-result" aria-live="polite"></div>
</div>

</div>

<div id="ocr-overlay"></div>
<div id="ocr-holder">
    <button class="ocr-close-btn" aria-label="Zavřít OCR">Zavřít</button>
    <video id="ocr-video" autoplay></video>
    <div id="ocr-selection"></div>
</div>
<canvas id="ocr-canvas"></canvas>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script type="module">

/* MRZ CHECK-DIGIT FUNKCE */
function charValue(c) {
  if (!c) return 0;
  if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;
  if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55;
  if (c === '<') return 0;
  return 0;
}

function calcMRZDigit(str) {
  const weights = [7,3,1];
  let sum = 0;
  for (let i=0;i<str.length;i++){sum += charValue(str[i])*weights[i%3];}
  return (sum % 10).toString();
}

function padRight(str,len){
  str=str||"";
  if(str.length>=len) return str.slice(0,len);
  return str + '<'.repeat(len-str.length);
}

function formatDateYYMMDD(yymmdd,mode='birth'){
  if(!/^\d{6}$/.test(yymmdd)) return yymmdd;
  const yy=parseInt(yymmdd.slice(0,2),10);
  const mm=yymmdd.slice(2,4);
  const dd=yymmdd.slice(4,6);
  const now=new Date();
  const currentYY=now.getFullYear()%100;
  let year;
  if(mode==='birth'){year=(yy>currentYY)?1900+yy:2000+yy;}
  else{year=(yy<70)?2000+yy:1900+yy;}
  return `${dd}.${mm}.${year}`;
}

/* VALIDACE VSTUPŮ */
function validateInputs(inputs, expectedLengths) {
  const errors = [];
  
  if (inputs.length !== expectedLengths.length) {
    errors.push(`Neplatný počet řádků. Očekáváno: ${expectedLengths.length}, zadané: ${inputs.length}`);
    return { isValid: false, errors };
  }
  
  inputs.forEach((input, index) => {
    if (input.length === 0) {
      errors.push(`Řádek ${index + 1} je prázdný`);
    } else if (input.length !== expectedLengths[index]) {
      errors.push(`Řádek ${index + 1} má nesprávnou délku. Očekáváno: ${expectedLengths[index]}, zadané: ${input.length}`);
    }
    
    // Kontrola povolených znaků
    const invalidChars = input.match(/[^A-Z0-9<]/g);
    if (invalidChars) {
      errors.push(`Řádek ${index + 1} obsahuje neplatné znaky: ${invalidChars.join(', ')}`);
    }
  });
  
  return {
    isValid: errors.length === 0,
    errors
  };
}

/* CP */
const countryCodes = {
  "AFG":"Afghanistan","ALB":"Albania","DZA":"Algeria","ASM":"American Samoa","AND":"Andorra","AGO":"Angola","AIA":"Anguilla",
  "ATA":"Antarctica","ATG":"Antigua and Barbuda","ARG":"Argentina","ARM":"Armenia","ABW":"Aruba","AUS":"Australia","AUT":"Austria",
  "AZE":"Azerbaijan","BHS":"Bahamas","BHR":"Bahrain","BGD":"Bangladesh","BRB":"Barbados","BLR":"Belarus","BEL":"Belgium",
  "BLZ":"Belize","BEN":"Benin","BMU":"Bermuda","BTN":"Bhutan","BOL":"Bolivia","BIH":"Bosnia and Herzegovina","BWA":"Botswana",
  "BVT":"Bouvet Island","BRA":"Brazil","IOT":"British Indian Ocean Territory","BRN":"Brunei Darussalam","BGR":"Bulgaria",
  "BFA":"Burkina Faso","BDI":"Burundi","KHM":"Cambodia","CMR":"Cameroon","CAN":"Canada","CPV":"Cape Verde","CYM":"Cayman Islands",
  "CAF":"Central African Republic","TCD":"Chad","CHL":"Chile","CHN":"China","CXR":"Christmas Island","CCK":"Cocos (Keeling) Islands",
  "COL":"Colombia","COM":"Comoros","COG":"Congo","COK":"Cook Islands","CRI":"Costa Rica","CIV":"Côte d'Ivoire","HRV":"Croatia",
  "CUB":"Cuba","CYP":"Cyprus","CZE":"Czech Republic","PRK":"Democratic People's Republic of Korea","COD":"Democratic Republic of the Congo",
  "DNK":"Denmark","DJI":"Djibouti","DMA":"Dominica","DOM":"Dominican Republic","TMP":"East Timor","ECU":"Ecuador","EGY":"Egypt",
  "SLV":"El Salvador","GNQ":"Equatorial Guinea","ERI":"Eritrea","EST":"Estonia","ETH":"Ethiopia","FLK":"Falkland Islands (Malvinas)",
  "FRO":"Faeroe Islands","FJI":"Fiji","FIN":"Finland","FRA":"France","FXX":"France, Metropolitan","GUF":"French Guiana","PYF":"French Polynesia",
  "GAB":"Gabon","GMB":"Gambia","GEO":"Georgia","D":"Germany","GHA":"Ghana","GIB":"Gibraltar","GRC":"Greece","GRL":"Greenland",
  "GRD":"Grenada","GLP":"Guadeloupe","GUM":"Guam","GTM":"Guatemala","GIN":"Guinea","GNB":"Guinea-Bissau","GUY":"Guyana","HTI":"Haiti",
  "HMD":"Heard and McDonald Islands","VAT":"Holy See (Vatican City State)","HND":"Honduras","HKG":"Hong Kong","HUN":"Hungary",
  "ISL":"Iceland","IND":"India","IDN":"Indonesia","IRN":"Iran, Islamic Republic of","IRQ":"Iraq","IRL":"Ireland","ISR":"Israel",
  "ITA":"Italy","JAM":"Jamaica","JPN":"Japan","JOR":"Jordan","KAZ":"Kazakhstan","KEN":"Kenya","KIR":"Kiribati","KWT":"Kuwait",
  "KGZ":"Kyrgyzstan","LAO":"Lao People's Democratic Republic","LVA":"Latvia","LBN":"Lebanon","LSO":"Lesotho","LBR":"Liberia",
  "LBY":"Libyan Arab Jamahiriya","LIE":"Liechtenstein","LTU":"Lithuania","LUX":"Luxembourg","MDG":"Madagascar","MWI":"Malawi",
  "MYS":"Malaysia","MDV":"Maldives","MLI":"Mali","MLT":"Malta","MHL":"Marshall Islands","MTQ":"Martinique","MRT":"Mauritania",
  "MUS":"Mauritius","MYT":"Mayotte","MEX":"Mexico","FSM":"Micronesia, Federated States of","MCO":"Monaco","MNG":"Mongolia",
  "MSR":"Montserrat","MAR":"Morocco","MOZ":"Mozambique","MMR":"Myanmar","NAM":"Namibia","NRU":"Nauru","NPL":"Nepal",
  "NLD":"Netherlands, Kingdom of the","ANT":"Netherlands Antilles","NTZ":"Neutral Zone","NCL":"New Caledonia","NZL":"New Zealand",
  "NIC":"Nicaragua","NER":"Niger","NGA":"Nigeria","NIU":"Niue","NFK":"Norfolk Island","MNP":"Northern Mariana Islands","NOR":"Norway",
  "OMN":"Oman","PAK":"Pakistan","PLW":"Palau","PAN":"Panama","PNG":"Papua New Guinea","PRY":"Paraguay","PER":"Peru","PHL":"Philippines",
  "PCN":"Pitcairn","POL":"Poland","PRT":"Portugal","PRI":"Puerto Rico","QAT":"Qatar","KOR":"Republic of Korea","MDA":"Republic of Moldova",
  "REU":"Réunion","ROM":"Romania","RUS":"Russian Federation","RWA":"Rwanda","SHN":"Saint Helena","KNA":"Saint Kitts and Nevis",
  "LCA":"Saint Lucia","SPM":"Saint Pierre and Miquelon","VCT":"Saint Vincent and the Grenadines","WSM":"Samoa","SMR":"San Marino",
  "STP":"Sao Tome and Principe","SAU":"Saudi Arabia","SEN":"Senegal","SYC":"Seychelles","SLE":"Sierra Leone","SGP":"Singapore",
  "SVK":"Slovakia","SVN":"Slovenia","SLB":"Solomon Islands","SOM":"Somalia","ZAF":"South Africa","SGS":"South Georgia and the South Sandwich Island",
  "ESP":"Spain","LKA":"Sri Lanka","SDN":"Sudan","SUR":"Suriname","SJM":"Svalbard and Jan Mayen Islands","SWZ":"Swaziland","SWE":"Sweden",
  "CHE":"Switzerland","SYR":"Syrian Arab Republic","TWN":"Taiwan Province of China","TJK":"Tajikistan","THA":"Thailand",
  "MKD":"The former Yugoslav Republic of Macedonia","TGO":"Togo","TKL":"Tokelau","TON":"Tonga","TTO":"Trinidad and Tobago",
  "TUN":"Tunisia","TUR":"Turkey","TKM":"Turkmenistan","TCA":"Turks and Caicos Islands","TUV":"Tuvalu","UGA":"Uganda",
  "UKR":"Ukraine","ARE":"United Arab Emirates","GBR":"United Kingdom of Great Britain and Northern Ireland - Citizen",
  "GBD":"United Kingdom of Great Britain and Northern Ireland - Dependent territories citizen",
  "GBN":"United Kingdom of Great Britain and Northern Ireland - National (overseas)",
  "GBO":"United Kingdom of Great Britain and Northern Ireland - Overseas citizen",
  "GBP":"United Kingdom of Great Britain and Northern Ireland - Protected Person",
  "GBS":"United Kingdom of Great Britain and Northern Ireland - Subject",
  "TZA":"United Republic of Tanzania","USA":"United States of America","UMI":"United States of America Minor Outlying Islands",
  "URY":"Uruguay","UZB":"Uzbekistan","VUT":"Vanuatu","VEN":"Venezuela","VNM":"Viet Nam","VGB":"Virgin Islands (Great Britain)",
  "VIR":"Virgin Islands (United States)","WLF":"Wallis and Futuna Islands","ESH":"Western Sahara","YEM":"Yemen",
  "ZAR":"Zaire","ZMB":"Zambia","ZWE":"Zimbabwe","XXA":"Bez st. příslušnosti","XXX":"Bez st. příslušnosti","XXK":"Kosovo"
};

function validatePassport(lines){
  // Validace vstupů
  const validation = validateInputs(lines, [44, 44]);
  if (!validation.isValid) {
    return {ok:false, html:"❌ Chyba ve vstupech:<br>" + validation.errors.join('<br>')};
  }

  const [l1,l2] = lines;
  const issuingCountryCode = l1.substring(2,5);
  const docNum = l2.substring(0,9);
  const docCD  = l2[9];
  const nationalityCode = l2.substring(10,13);
  const dob = l2.substring(13,19);
  const dobCD = l2[19];
  const sex = l2[20];
  const exp = l2.substring(21,27);
  const expCD = l2[27];
  const personalRaw = l2.substring(28,42);
  const personalCD = l2[42];
  const compCD = l2[43];
  const compositeStr = l2.substring(0,10) + l2.substring(13,20) + l2.substring(21,43);

  let out = "<b>Výsledky kontroly pasu:</b>\n\n";
  out += `Osobní číslo (rč): ${personalRaw.replace(/</g,'')}\n`;
  out += `Vydavatel: ${countryCodes[issuingCountryCode]||"Neznámý"} (${issuingCountryCode}) ` +
          ((issuingCountryCode in countryCodes)?"<span class='ok'>✔ OK</span>\n":"<span class='bad'>❌NOK</span>\n");
  out += `Číslo pasu: ${docNum.replace(/<+$/,'')} ` + 
          (calcMRZDigit(padRight(docNum,9))===docCD ? "<span class='ok'>✔ OK</span>\n" : "<span class='bad'>❌NOK</span>\n");
  out += `Národnost: ${countryCodes[nationalityCode]||"Neznámý"} (${nationalityCode}) ` + 
          ((nationalityCode in countryCodes)?"<span class='ok'>✔ OK</span>\n":"<span class='bad'>❌NOK</span>\n");
  out += `Datum narození: ${formatDateYYMMDD(dob,'birth')} ` + 
          (calcMRZDigit(dob)===dobCD ? "<span class='ok'>✔ OK</span>\n" : "<span class='bad'>❌NOK</span>\n");
  out += `Datum expirace: ${formatDateYYMMDD(exp,'expiry')} ` + 
          (calcMRZDigit(exp)===expCD ? "<span class='ok'>✔ OK</span>\n" : "<span class='bad'>❌NOK</span>\n");
  out += `Kontrolní číslice z čísla dokladu: ${calcMRZDigit(padRight(docNum,9))===docCD ? "<span class='ok'>✔ OK</span>" : "<span class='bad'>❌NOK</span>"}\n`;
  out += `Kontrolní číslice z data narození: ${calcMRZDigit(dob)===dobCD ? "<span class='ok'>✔ OK</span>" : "<span class='bad'>❌NOK</span>"}\n`;
  out += `Kontrolní číslice z data expirace: ${calcMRZDigit(exp)===expCD ? "<span class='ok'>✔ OK</span>" : "<span class='bad'>❌NOK</span>"}\n`;
  out += `Kontrolní číslice z osobního čísla: ${calcMRZDigit(padRight(personalRaw,14))===personalCD ? "<span class='ok'>✔ OK</span>" : "<span class='bad'>❌NOK</span>"}\n`;
  out += `Finalní kontrolní číslice: ${calcMRZDigit(compositeStr)===compCD ? "<span class='ok'>✔ OK</span>" : "<span class='bad'>❌NOK</span>"}`;

  return {ok:true, html:out};
}


/* EU NPT */
function validateID(lines){
  // Validace vstupů
  const validation = validateInputs(lines, [30, 30, 30]);
  if (!validation.isValid) {
    return {ok:false, html:"❌ Chyba ve vstupech:<br>" + validation.errors.join('<br>')};
  }

  const [l1,l2,l3]=lines;
  const docnum=l1.substring(5,14), docCD=l1[14];
  const dob=l2.substring(0,6), dobCD=l2[6];
  const exp=l2.substring(8,14), expCD=l2[14];
  const personal=l2.substring(18,29); // 11 znaků TD1
  const composite=padRight(docnum,9)+docCD+dob+dobCD+exp+expCD+padRight(personal,11);
  const compositeCD=l2[29];

  let out="<b>Výsledky kontroly OP/NPT/PPP:</b>\n\n";
  const personalTrimmed = personal.replace(/</g,'').trim();
  if(personalTrimmed) out+="Osobní číslo: "+personalTrimmed+"\n";
  out+="Číslo dokladu: "+docnum+" "+(calcMRZDigit(padRight(docnum,9))===docCD?"<span class='ok'>✔ OK</span>\n":"<span class='bad'>❌NOK</span>\n");
  out+="Datum narození: "+formatDateYYMMDD(dob,'birth')+" "+(calcMRZDigit(dob)===dobCD?"<span class='ok'>✔ OK</span>\n":"<span class='bad'>❌NOK</span>\n");
  out+="Datum expirace: "+formatDateYYMMDD(exp,'expiry')+" "+(calcMRZDigit(exp)===expCD?"<span class='ok'>✔ OK</span>\n":"<span class='bad'>❌NOK</span>\n");


  out+="Kontrolní číslice: "+(calcMRZDigit(composite)===compositeCD?"<span class='ok'>✔ OK</span>":"<span class='bad'>❌NOK</span>");

  return {ok:true, html:out};
}


// SPOLEČNÁ FUNKCE PRO KONTROLU MRZ
function performMRZCheck(section) {
  const inputs = [...section.querySelectorAll("input")].map(i => i.value.trim().toUpperCase());
  let output;
  
  if(inputs.length === 3) {
    output = validateID(inputs).html;
  } else if(inputs.length === 2) {
    output = validatePassport(inputs).html;
  } else {
    output = "❌ Neplatný počet řádků.";
  }
  
  const resultDiv = section.querySelector(".mrz-result");
  resultDiv.innerHTML = output;
  resultDiv.classList.add('show');
}

document.querySelectorAll(".section").forEach(sec => {
  const btn = sec.querySelector(".kontrola-btn");
  if(!btn) return;

  btn.addEventListener("click", () => {
    performMRZCheck(sec);
  });
});


document.querySelectorAll('.insert-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const input = btn.previousElementSibling;
    if(input && input.tagName === 'INPUT'){
      input.value += '<';
      input.focus();
    }
  });
});


// ---------------------------------------------
// LOGIKA PRO OCR ZE SDÍLENÉ OBRAZOVKY
// ---------------------------------------------
const ocrVideo = document.getElementById("ocr-video");
const ocrCanvas = document.getElementById("ocr-canvas");
const ocrSelection = document.getElementById("ocr-selection");
const ocrHolder = document.getElementById("ocr-holder");
const ocrOverlay = document.getElementById("ocr-overlay");
const ocrCloseBtn = document.querySelector(".ocr-close-btn");

let currentStream = null;
let targetInputs = null; // Pole pro uložení vstupních polí, kam se má uložit výsledek
let numLines = null; // Počet očekávaných řádků (2 nebo 3)
let currentSection = null; // Odkaz na sekci, pro kterou běží OCR (pro aktualizaci statusu)

let selecting = false;
let startX, startY, endX, endY;

function updateStatus(sec, message, isError = false) {
    const statusSpan = sec.querySelector('.ocr-status');
    if (statusSpan) {
        statusSpan.textContent = message;
        statusSpan.style.color = isError ? '#ff6b6b' : '#000';
    }
}

// Spuštění sdílení obrazovky
async function startScreenShare(section, inputs, lines) {
    targetInputs = inputs;
    numLines = lines;
    currentSection = section;
    
    // Vyčistíme status u všech sekcí, aby se zobrazoval jen u aktuální
    document.querySelectorAll('.ocr-status').forEach(span => span.textContent = '');

    try {
        currentStream = await navigator.mediaDevices.getDisplayMedia({ 
            video: { 
                cursor: 'always' 
            }, 
            audio: false 
        });
        
        // Přidáme listener pro ukončení streamu uživatelem
        currentStream.getTracks().forEach(track => {
            track.addEventListener('ended', () => {
                stopScreenShare();
            });
        });
        
        ocrVideo.srcObject = currentStream;
        ocrHolder.style.display = 'block';
        ocrOverlay.style.display = 'block';
        
        updateStatus(currentSection, "Vyberte oblast MRZ myší a pusťte...");
    } catch (err) {
        console.error(err);
        updateStatus(currentSection, "❌ Chyba při sdílení: " + err.message, true);
        ocrHolder.style.display = 'none';
        ocrOverlay.style.display = 'none';
        currentStream = null;
    }
}

// Zastavení sdílení obrazovky a vyčištění
function stopScreenShare() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    ocrHolder.style.display = 'none';
    ocrOverlay.style.display = 'none';
    ocrSelection.style.width = "0px";
    ocrSelection.style.height = "0px";
    selecting = false;
    
    if (currentSection) {
        updateStatus(currentSection, "");
        currentSection = null;
    }
    
    targetInputs = null;
    numLines = null;
}

// Přiřazení události pro OCR tlačítka
document.querySelectorAll(".ocr-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const section = btn.closest('.section');
        const inputs = [...section.querySelectorAll('input[type="text"]')];
        const lines = parseInt(btn.dataset.lines, 10);
        startScreenShare(section, inputs, lines); 
    });
});

// Události pro zavírací tlačítko
ocrCloseBtn.addEventListener("click", stopScreenShare);
ocrOverlay.addEventListener("click", stopScreenShare);

// Zabránění zavření při kliknutí na samotný holder
ocrHolder.addEventListener("click", (e) => {
    e.stopPropagation();
});

// Začátek výběru
ocrHolder.addEventListener("mousedown", e => {
    if (!currentStream) return;
    const rect = ocrVideo.getBoundingClientRect();
    selecting = true;
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    ocrSelection.style.left = startX + "px";
    ocrSelection.style.top = startY + "px";
    ocrSelection.style.width = "0px";
    ocrSelection.style.height = "0px";
});

// Pohyb myši při výběru
ocrHolder.addEventListener("mousemove", e => {
    if (!selecting || !currentStream) return;
    const rect = ocrVideo.getBoundingClientRect();
    endX = e.clientX - rect.left;
    endY = e.clientY - rect.top;
    
    // Zajištění, že se výběr neobjeví mimo video
    const videoWidth = ocrVideo.clientWidth;
    const videoHeight = ocrVideo.clientHeight;
    endX = Math.max(0, Math.min(endX, videoWidth));
    endY = Math.max(0, Math.min(endY, videoHeight));

    ocrSelection.style.left = Math.min(startX, endX) + "px";
    ocrSelection.style.top = Math.min(startY, endY) + "px";
    ocrSelection.style.width = Math.abs(endX - startX) + "px";
    ocrSelection.style.height = Math.abs(endY - startY) + "px";
});

// Konec výběru a OCR
ocrHolder.addEventListener("mouseup", async () => {
    if (!currentStream || !selecting || !currentSection) return;
    selecting = false;
    
    const sx = Math.min(startX, endX);
    const sy = Math.min(startY, endY);
    const sw = Math.abs(endX - startX);
    const sh = Math.abs(endY - startY);

    if (sw < 10 || sh < 10) { 
        updateStatus(currentSection, "❌ Výběr je příliš malý.", true);
        return;
    }

    ocrCanvas.width = sw;
    ocrCanvas.height = sh;
    const ctx = ocrCanvas.getContext("2d");

    // Krátká prodleva pro stabilizaci snímku
    await new Promise(r => setTimeout(r, 50)); 
    ctx.drawImage(ocrVideo, sx, sy, sw, sh, 0, 0, sw, sh);

    updateStatus(currentSection, "Probíhá OCR, prosím čekejte...");
    
    try {
        const result = await Tesseract.recognize(
            ocrCanvas,
            'mrz',
            {
                langPath: 'https://cdn.jsdelivr.net/gh/dominik9g/mrz-ocr@main/',
                tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<",
                logger: m => console.log(m)
            }
        );

        const mrzText = result.data.text.trim().toUpperCase();
        
        // Rozdělení na řádky a vyplnění polí
        const lines = mrzText.split('\n').filter(line => line.trim().length > 0);
        
        if(lines.length < numLines) {
            updateStatus(currentSection, `❌ OCR detekovalo jen ${lines.length} řádků (očekáváno ${numLines}). Zkuste to znovu.`, true);
            return;
        }

        for(let i = 0; i < numLines; i++) {
            if (targetInputs[i]) {
                targetInputs[i].value = lines[i]; 
            }
        }
        
        updateStatus(currentSection, "✅ OCR dokončeno. Řádky vyplněny.");
        
        // Automaticky provést kontrolu po úspěšném OCR
        setTimeout(() => {
            performMRZCheck(currentSection);
        }, 500);

    } catch (err) {
        console.error(err);
        updateStatus(currentSection, "❌ Chyba při OCR: " + err.message, true);
    } finally {
        // Zavřít sdílení obrazovky po dokončení OCR
        stopScreenShare();
    }
});

// Přidání klávesových zkratek pro lepší přístupnost
document.addEventListener('keydown', (e) => {
    // ESC pro zavření OCR overlay
    if (e.key === 'Escape' && currentStream) {
        stopScreenShare();
    }
});

// Cleanup při opuštění stránky
window.addEventListener('beforeunload', () => {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});
</script>
</body>
</html>
