<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>NumerID</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiM1NUM0NUYiLz48dGV4dCB4PSIzMiIgeT0iMzIiIGZvbnQtc2l6ZT0iNDYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJjZW50cmFsIiBmaWxsPSIjMDAwIiBmb250LXdlaWdodD0iNzAwIiBmb250LWZhbWlseT0iUm9ib3RvLCBTYW5zLXNlcmlmIj5JRDwvdGV4dD48L3N2Zz4=">

<style>
  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: #f7f7f5;
    color: #222;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
  }

  .wrapper {
    width: 90%;
    max-width: 640px;
    margin: 30px 0;
  }

  .header {
    background: #9fdc00;
    color: #000;
    padding: 30px 0;
    font-size: 3em;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 16px;
  }

  .header sub {
    font-size: 0.25em;
    opacity: 0.3;
    margin-left: -5px;	
  }

  .section {
    margin: 30px 0;
    padding: 18px 35px 30px 35px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
    position: relative;
  }

  .section h2 {
    color: #000;
    font-size: 1.3em;
    margin-top: 0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .help-btn {
    background: #9fdc00;
    border: none;
    color: #000;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }

  .help-btn:hover { background: #7cc400; }

  .tooltip {
    display: none;
    position: absolute;
    top: 0;
    left: 30px;
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 14px 18px;
    border-radius: 10px;
    font-size: 0.95em;
    line-height: 1.5em;
    text-align: left;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
  }

  .tooltip b {
    color: #9fdc00;
    font-weight: 600;
  }

  .help-btn:hover .tooltip { display: block; }

  input {
    width: 100%;
    padding: 10px;
    font-size: 1em;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 8px;
  }

  .kontrola-btn {
    background: #000;
    color: #9fdc00;
    border: none;
    border-radius: 10px;
    padding: 10px 22px;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    margin-right: 10px;
  }
  
  .ocr-btn {
    background: #000;
    color: #9fdc00;
    border: none;
    border-radius: 10px;
    padding: 10px 22px;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    margin-right: 10px;
  }

  .kontrola-btn:hover { background: #333; }
  .ocr-btn:hover { background: #333; }

  /* OCR ZPRÁVY POD TLAČÍTKY */
  .ocr-message-area {
      margin-top: 15px;
      font-size: 0.95em;
      min-height: 1.2em;
      line-height: 1.2em;
      font-weight: 600;
      color: #222; /* Výchozí barva pro instrukce/probíhá */
  }
  .ocr-message-area.success {
      color: #008800; /* Barva pro úspěch (sladěná se zelenou) */
  }
  .ocr-message-area.error {
      color: #ff6b6b; /* Barva pro chybu (červená) */
  }
  /* Konec OCR ZPRÁV */


  /* výstup MRZ vlevo od hlavní sekce */
  .mrz-result {
    display: none;
    position: absolute;
    top: 0;
    left: -350px;
    width: 300px;
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.95em;
    line-height: 1.4em;
    text-align: left;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.08);
    white-space: pre-wrap;
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .mrz-result.show {
    display: block;
    opacity: 1;
    transform: translateX(0);
  }

  .mrz-result b { color: #9fdc00;}
  /* Odebrány ok a bad třídy pro ikony */

.insert-btn {
  background: #888;         
  color: #fff;              
  padding: 10px;
  font-size: 1em;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 8px;
  opacity: 0.3; 
  transition: opacity 0.2s;
}

.insert-btn:hover {
  opacity: 1;              
}

/* Styly pro velký, modální OCR video/výběrovou oblast */
#ocr-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: none;
}

#ocr-holder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    padding: 0;
    max-width: 90vw; 
    max-height: 90vh;
    display: none;
}

#ocr-holder video { 
    max-width: 100%; 
    max-height: 80vh; 
    height: auto;
    border: 3px solid #9fdc00; 
    display: block; 
}

#ocr-selection { 
    position: absolute; 
    border: 2px dashed red; 
    pointer-events: none; 
}

#ocr-canvas { display: none; }
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">NumerID<sub>v0.2</sub></div>

 
<div class="section" id="mrz-id-section">
  <h2>MRZ – OP/NPT/PPP
    <button class="help-btn">?
      <div class="tooltip">1. Zadej první, druhý a třetí řádek MRZ včetně šipek.<br>
          2. Šipky můžeš vkládat pomocí kliknutí na tlačítko vedle vkládacího pole.<br>
          3. Poté klikni na <b>KONTROLA</b>.<br>
        </div>
    </button>
  </h2>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 1 (MRZ ID)">
    <button class="insert-btn" style="margin-left:5px;">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 2 (MRZ ID)">
    <button class="insert-btn" style="margin-left:5px;">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 3 (MRZ ID)">
    <button class="insert-btn" style="margin-left:5px;">&lt;</button>
  </div>
  <button class="kontrola-btn">KONTROLA</button>
  <button class="ocr-btn" data-lines="3">OCR</button> 
  <div class="ocr-message-area"></div> <div class="mrz-result" aria-live="polite"></div>
</div>


<div class="section" id="mrz-passport-section">
  <h2>MRZ – Cestovní pas 
    <button class="help-btn">?
      <div class="tooltip">1. Zadej první a druhý řádek MRZ včetně šipek.<br>
          2. Šipky můžeš vkládat pomocí kliknutí na tlačítko vedle vkládacího pole.<br>
          3. Poté klikni na <b>KONTROLA</b>.<br>
        </div>
    </button>
  </h2>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 1 (MRZ pas)">
    <button class="insert-btn" style="margin-left:5px;">&lt;</button>
  </div>
  <div style="display:flex; align-items:center; margin-bottom:8px;">
    <input type="text" placeholder="Řádek 2 (MRZ pas)">
    <button class="insert-btn" style="margin-left:5px;">&lt;</button>
  </div>
  <button class="kontrola-btn">KONTROLA</button>
  <button class="ocr-btn" data-lines="2">OCR</button> 
  <div class="ocr-message-area"></div> <div class="mrz-result" aria-live="polite"></div>
</div>

</div>

<div id="ocr-overlay"></div>
<div id="ocr-holder">
    <video id="ocr-video" autoplay></video>
    <div id="ocr-selection"></div>
</div>
<canvas id="ocr-canvas"></canvas>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script type="module">

/* Odstraněny definice successAudio a errorAudio */

/* MRZ CHECK-DIGIT FUNKCE */
function charValue(c) {
  if (!c) return 0;
  if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;
  if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55;
  if (c === '<') return 0;
  return 0;
}

function calcMRZDigit(str) {
  const weights = [7,3,1];
  let sum = 0;
  for (let i=0;i<str.length;i++){sum += charValue(str[i])*weights[i%3];}
  return (sum % 10).toString();
}

function padRight(str,len){
  str=str||"";
  if(str.length>=len) return str.slice(0,len);
  return str + '<'.repeat(len-str.length);
}

function formatDateYYMMDD(yymmdd,mode='birth'){
  if(!/^\d{6}$/.test(yymmdd)) return yymmdd;
  const yy=parseInt(yymmdd.slice(0,2),10);
  const mm=yymmdd.slice(2,4);
  const dd=yymmdd.slice(4,6);
  const now=new Date();
  const currentYY=now.getFullYear()%100;
  let year;
  if(mode==='birth'){year=(yy>currentYY)?1900+yy:2000+yy;}
  else{year=(yy<70)?2000+yy:1900+yy;}
  return `${dd}.${mm}.${year}`;
}

/* CP */
const countryCodes = {
  // Zůstává definice countryCodes, která je rozsáhlá, ale pro stručnost zde zkrácena
  "AFG":"Afghanistan","ALB":"Albania", "CZE":"Czech Republic", "D":"Germany",
  "GBR":"United Kingdom of Great Britain and Northern Ireland - Citizen",
  "USA":"United States of America","XXX":"Bez st. příslušnosti","XXK":"Kosovo"
};

function checkStatusText(isOk) {
    return isOk ? "(OK)" : "(NOK)";
}

function validatePassport(lines){
  const [l1,l2] = lines;
  if(l1.length !== 44 || l2.length !== 44) {
      return {ok:false, html:"Pas má mít 2 řádky po 44 znacích."};
  }

  const issuingCountryCode = l1.substring(2,5);
  const docNum = l2.substring(0,9);
  const docCD  = l2[9];
  const nationalityCode = l2.substring(10,13);
  const dob = l2.substring(13,19);
  const dobCD = l2[19];
  const exp = l2.substring(21,27);
  const expCD = l2[27];
  const personalRaw = l2.substring(28,42);
  const personalCD = l2[42];
  const compositeStr = l2.substring(0,10) + l2.substring(13,20) + l2.substring(21,43);
  const compCD = l2[43];

  const docNumCheck = calcMRZDigit(padRight(docNum,9))===docCD;
  const dobCheck = calcMRZDigit(dob)===dobCD;
  const expCheck = calcMRZDigit(exp)===expCD;
  const personalCheck = calcMRZDigit(padRight(personalRaw,14))===personalCD;
  const compositeCheck = calcMRZDigit(compositeStr)===compCD;

  let out = "<b>Výsledky kontroly pasu:</b>\n\n";
  out += `Osobní číslo (rč): ${personalRaw.replace(/</g,'')}\n`;
  out += `Vydavatel: ${countryCodes[issuingCountryCode]||"Neznámý"} (${issuingCountryCode}) ${checkStatusText(issuingCountryCode in countryCodes)}\n`;
  out += `Číslo pasu: ${docNum.replace(/<+$/,'')} ${checkStatusText(docNumCheck)}\n`;
  out += `Národnost: ${countryCodes[nationalityCode]||"Neznámý"} (${nationalityCode}) ${checkStatusText(nationalityCode in countryCodes)}\n`;
  out += `Datum narození: ${formatDateYYMMDD(dob,'birth')} ${checkStatusText(dobCheck)}\n`;
  out += `Datum expirace: ${formatDateYYMMDD(exp,'expiry')} ${checkStatusText(expCheck)}\n`;
  out += `Kontrolní číslice z čísla dokladu: ${checkStatusText(docNumCheck)}\n`;
  out += `Kontrolní číslice z data narození: ${checkStatusText(dobCheck)}\n`;
  out += `Kontrolní číslice z data expirace: ${checkStatusText(expCheck)}\n`;
  out += `Kontrolní číslice z osobního čísla: ${checkStatusText(personalCheck)}\n`;
  out += `Finalní kontrolní číslice: ${checkStatusText(compositeCheck)}`;

  return {ok:true, html:out};
}


/* EU NPT */
function validateID(lines){
  const [l1,l2,l3]=lines;
  if(l1.length!==30 || l2.length!==30 || l3.length!==30) {
      return {ok:false, html:"Doklad má mít 3 řádky po 30 znacích."};
  }

  const docnum=l1.substring(5,14), docCD=l1[14];
  const dob=l2.substring(0,6), dobCD=l2[6];
  const exp=l2.substring(8,14), expCD=l2[14];
  const personal=l2.substring(18,29); 
  const composite=padRight(docnum,9)+docCD+dob+dobCD+exp+expCD+padRight(personal,11);
  const compositeCD=l2[29];
  
  const docNumCheck = calcMRZDigit(padRight(docnum,9))===docCD;
  const dobCheck = calcMRZDigit(dob)===dobCD;
  const expCheck = calcMRZDigit(exp)===expCD;
  const compositeCheck = calcMRZDigit(composite)===compositeCD;

  let out="<b>Výsledky kontroly OP/NPT/PPP:</b>\n\n";
  const personalTrimmed = personal.replace(/</g,'').trim();
  if(personalTrimmed) out+="Osobní číslo: "+personalTrimmed+"\n";
  out+="Číslo dokladu: "+docnum+" "+checkStatusText(docNumCheck)+"\n";
  out+="Datum narození: "+formatDateYYMMDD(dob,'birth')+" "+checkStatusText(dobCheck)+"\n";
  out+="Datum expirace: "+formatDateYYMMDD(exp,'expiry')+" "+checkStatusText(expCheck)+"\n";

  out+="Kontrolní číslice: "+checkStatusText(compositeCheck);

  return {ok:true, html:out};
}


document.querySelectorAll(".section").forEach(sec=>{
  const btn=sec.querySelector(".kontrola-btn");
  if(!btn) return;
  const resultDiv=sec.querySelector(".mrz-result");

  btn.addEventListener("click",()=>{
    const inputs=[...sec.querySelectorAll("input")].map(i=>i.value.trim().toUpperCase());
    let output;
    if(inputs.length===3){output=validateID(inputs).html;}
    else if(inputs.length===2){output=validatePassport(inputs).html;}
    else{output="Neplatný počet řádků.";}
    
    resultDiv.innerHTML=output;
    resultDiv.classList.add('show');
  });
});


document.querySelectorAll('.insert-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const input = btn.previousElementSibling;
    if(input && input.tagName === 'INPUT'){
      input.value += '<';
      input.focus();
    }
  });
});


// ---------------------------------------------
// LOGIKA PRO OCR ZE SDÍLENÉ OBRAZOVKY
// ---------------------------------------------
const ocrVideo = document.getElementById("ocr-video");
const ocrCanvas = document.getElementById("ocr-canvas");
const ocrSelection = document.getElementById("ocr-selection");
const ocrHolder = document.getElementById("ocr-holder");
const ocrOverlay = document.getElementById("ocr-overlay");
let currentStream;
let targetInputs; // Pole pro uložení vstupních polí
let numLines; // Počet očekávaných řádků (2 nebo 3)
let currentSection; // Odkaz na sekci, pro kterou běží OCR

function updateStatus(sec, message, statusClass = '') {
    const statusDiv = sec.querySelector('.ocr-message-area');
    if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.className = 'ocr-message-area ' + statusClass;
    }
}

// Spuštění sdílení obrazovky
async function startScreenShare(section, inputs, lines) {
    targetInputs = inputs;
    numLines = lines;
    currentSection = section;
    
    // Vyčistíme status u všech sekcí
    document.querySelectorAll('.ocr-message-area').forEach(div => div.textContent = '');

    try {
        currentStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        ocrVideo.srcObject = currentStream;
        ocrHolder.style.display = 'block';
        ocrOverlay.style.display = 'block';
        
        updateStatus(currentSection, "Sdílení obrazovky aktivní. Vyberte oblast MRZ myší a pusťte.");
    } catch (err) {
        console.error(err);
        updateStatus(currentSection, "Chyba při sdílení obrazovky: " + err.message, 'error');
        ocrHolder.style.display = 'none';
        ocrOverlay.style.display = 'none';
    }
}

// Zastavení sdílení obrazovky a vyčištění
function stopScreenShare() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
    ocrHolder.style.display = 'none';
    ocrOverlay.style.display = 'none';
    ocrSelection.style.width = "0px";
    ocrSelection.style.height = "0px";
    selecting = false;
    currentSection = null;
}

// Přiřazení události pro OCR tlačítka
document.querySelectorAll(".ocr-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const section = btn.closest('.section');
        const inputs = [...section.querySelectorAll('input[type="text"]')];
        const lines = parseInt(btn.dataset.lines, 10);
        startScreenShare(section, inputs, lines); 
    });
});

// Události pro výběr myší

// Začátek výběru
ocrHolder.addEventListener("mousedown", e => {
    if (!currentStream) return;
    const rect = ocrVideo.getBoundingClientRect();
    selecting = true;
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    ocrSelection.style.left = startX + "px";
    ocrSelection.style.top = startY + "px";
    ocrSelection.style.width = "0px";
    ocrSelection.style.height = "0px";
});

// Pohyb myši při výběru
ocrHolder.addEventListener("mousemove", e => {
    if (!selecting || !currentStream) return;
    const rect = ocrVideo.getBoundingClientRect();
    endX = e.clientX - rect.left;
    endY = e.clientY - rect.top;
    
    // Zajištění, že se výběr neobjeví mimo video
    const videoWidth = ocrVideo.clientWidth;
    const videoHeight = ocrVideo.clientHeight;
    endX = Math.max(0, Math.min(endX, videoWidth));
    endY = Math.max(0, Math.min(endY, videoHeight));

    ocrSelection.style.left = Math.min(startX, endX) + "px";
    ocrSelection.style.top = Math.min(startY, endY) + "px";
    ocrSelection.style.width = Math.abs(endX - startX) + "px";
    ocrSelection.style.height = Math.abs(endY - startY) + "px";
});

// Konec výběru a OCR
ocrHolder.addEventListener("mouseup", async () => {
    if (!currentStream || !selecting || !currentSection) return;
    selecting = false;
    
    const sx = Math.min(startX, endX);
    const sy = Math.min(startY, endY);
    const sw = Math.abs(endX - startX);
    const sh = Math.abs(endY - startY);

    if (sw < 10 || sh < 10) { 
        updateStatus(currentSection, "Výběr je příliš malý. Zkuste to znovu.", 'error');
        stopScreenShare();
        return;
    }

    ocrCanvas.width = sw;
    ocrCanvas.height = sh;
    const ctx = ocrCanvas.getContext("2d");

    await new Promise(r => setTimeout(r, 50)); 
    ctx.drawImage(ocrVideo, sx, sy, sw, sh, 0, 0, sw, sh);

    updateStatus(currentSection, "Probíhá OCR, prosím čekejte...");
    
    try {
        const result = await Tesseract.recognize(
            ocrCanvas,
            'mrz',
            {
                langPath: 'https://dominik9g.github.io/mrz-ocr/', 
                tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<",
                logger: m => console.log(m)
            }
        );

        const mrzText = result.data.text.trim().toUpperCase();
        
        const lines = mrzText.split('\n').filter(line => line.trim().length > 0);
        
        if(lines.length < numLines) {
            updateStatus(currentSection, `OCR detekovalo jen ${lines.length} řádků (očekáváno ${numLines}). Zkuste to znovu.`, 'error');
            return;
        }

        for(let i = 0; i < numLines; i++) {
            if (targetInputs[i]) {
                targetInputs[i].value = lines[i]; 
            }
        }
        
        updateStatus(currentSection, "OCR úspěšně dokončeno. Řádky vyplněny.", 'success');

    } catch (err) {
        console.error(err);
        updateStatus(currentSection, "Chyba při OCR: " + err.message, 'error');
    } finally {
        stopScreenShare();
    }
});
</script>
</body>
</html>
